# REQ007: Percent Format for Jupyter Notebook Like Document

为记录 Jupyter Notebook 到文本文件中，Jupyter 社区提出 Jupyter Text 项目，支持多种文本形式，Percent 是其中一种。

## 基本格式

使用 `# %%` 表示 Cell 的开始，后跟可选的标题和元数据：

```markdown
# %% Optional title[^1]

[^1]: [cell type] key="value"
```

### 格式说明

1. **标题部分**：
   - 以 `# %%` 开头，后跟一个空格
   - 接着是可选的标题文本
   - 使用 `[^ref]` 格式引用脚注，其中 `ref` 可以是数字或字符串

2. **元数据部分**：
   - 使用 Markdown 脚注语法 `[^ref]:` 定义元数据
   - 元数据格式为 `[cell type] key="value"`
   - 支持多行元数据定义

### 示例

```markdown
# %% 数据分析示例[^data_cell]
[^data_cell]: [code] language="python" execution_count=1

```

### 编程语言注释

如果基础文档是编程语言，percent heading 部分需要放在注释内：

```python
# %% 数据处理[^process_data]
[^process_data]: [code] cell_type="code" execution_count=2
```

> **注意**：在 Jupyter 中，Cell 的 Output 是 Cell 本身的一部分

```markdown
%%% [output:stdout] agent="custom-agent" time=xxxx
```

## Agent 定义

```markdown
# %% 自定义Agent定义[^agent_def]
[^agent_def]: [markdown] definition="agent" name="custom-agent"

用于在对话上下文中，定义一个 agent. 目前将 Agent 视为 System Prompt + 推理参数的容器。


```markdown
# %% 自定义Agent定义[^agent_config]
[^agent_config]: [markdown] definition="agent" name="custom-agent"

```yaml
---
models: [deepseek-v3]
context_window: 200000
max_output_tokens: 8192
reasoning: true
use_temperature: true
temperature: 0.7
---
# Custom Agent
This is an ad-hoc generated agent with specific capabilities...
```
```

## 标准对话：用户输入

用户输入使用以下格式：

```markdown
# %% 用户输入[^user_input]
[^user_input]: [markdown] history="none" key="value"
```

### 元数据说明

- `key="value"`：遵循 Jupyter Text 风格
- `history`：控制对话历史的记录方式
  - `none` | `exclude` | `0` | `false`：不记录
  - `include` | `1` | `true`：完整记录
  - `summary`：仅记录摘要

> **实现建议**：
> 可以引入小模型对对话内容进行评分，智能判断是否应包含在对话历史中。

## 标准输出格式

### LLM 输出

```markdown
# %%% 输出标题[^output_meta]
[^output_meta]: [output] agent="custom-agent" time="2025-05-30T00:00:00+08:00"

输出内容...
```

### 工具调用输出

```markdown
# %%% 工具调用结果[^tool_result]
[^tool_result]: [tool] name="tool_name" status="success" duration=0.5s

工具返回结果...
```

### 异步输出

工具 与 LLM 均可能需要运行很长时间才能完成，因此需要支持异步输出。

```markdown
# %% 异步输出[^async_output]
[^async_output]: [async](file_name) id="123"
```


### 格式说明

1. **输出标识**：
   - 使用 `# %%%` 作为输出块的开始
   - 后跟可选的输出描述
   - 使用 `[^ref]` 引用元数据

2. **元数据部分**：
   - 使用 Markdown 脚注语法 `[^ref]:` 定义
   - 元数据格式为 `[type] key="value"`
   - 支持多行元数据定义

3. **输出类型**：
   - `[output]`：标准输出
   - `[tool]`：工具调用结果
   - `[error]`：错误信息

4. **标准元数据字段**：
   - `agent`：输出来源
   - `time`：时间戳（ISO 8601 格式）
   - `status`：执行状态（success/failed）
   - `duration`：执行时间（秒）
   - `session_id`：会话标识符


## 命令行工具

### 基本用法

```bash
# 创建新对话
tce chat ITEM -m "消息内容"

# 在指定模块下创建对话
tce chat MODULE_PREFIX [agent_name|module] -m "消息内容"
```

### 对话历史管理

```bash
# 包含其他对话历史
tce chat ITEM -i OTHER_ITEM/[1..n] -m "消息内容"
tce chat ITEM --include OTHER_ITEM/item/[1..n] -m "消息内容"

# 排除特定对话历史
tce chat ITEM -e [1..n] -m "消息内容"
tce chat ITEM --exclude /item[1..n] -m "消息内容"
tce chat ITEM -e OTHER_ITEM/[m] -m "消息内容"

# 保存历史记录配置
--save  # 将 include/exclude 配置保存到元数据
```

### 查看对话

```bash
# 列出对话历史
tce list ITEM/item
```

### 参数说明

- `MODULE_PREFIX`: 模块前缀
- `agent_name|module`: 指定 agent 或模块
- `-i, --include`: 包含其他对话历史
- `-e, --exclude`: 排除特定对话历史
- `-m`: 消息内容
- `--save`: 保存配置到元数据


## 工具作为特殊 Agent

工具（Tool）可以视为一种特殊的 Agent，具有以下特点：

1. **工具定义**：
   ```markdown
   # %% 工具定义[^tool_def]
   [^tool_def]: [tool] name="weather" description="获取天气信息"
   
   ```python
   def get_weather(city: str) -> str:
       """获取指定城市的天气信息"""
       return f"{city} 25°C 晴朗"
   ```
   ```

2. **工具调用**：
   ```markdown
   # %% 天气查询[^weather_query]
   [^weather_query]: [tool_call] tool="weather" args='{"city":"北京"}'
   
   # %%% 查询结果[^weather_result]
   [^weather_result]: [tool_result] tool="weather" status="success" duration=0.5
   
   北京 25°C 晴朗
   ```

### 工具元数据

- **工具定义**：
  - `name`：工具名称（必需）
  - `description`：工具描述
  - `version`：工具版本
  - `parameters`：参数定义（JSON Schema）

- **工具调用**：
  - `tool`：工具名称
  - `args`：调用参数（JSON 字符串）
  - `timeout`：超时时间（秒）

- **工具结果**：
  - `status`：执行状态（success/failed）
  - `duration`：执行时间（秒）
  - `error`：错误信息（如果执行失败）

### 工具链支持

工具可以组合成工具链（Toolchain），通过元数据指定执行顺序和参数传递：

```markdown
# %% 数据处理流程[^pipeline]
[^pipeline]: [toolchain] tools=["data_clean", "feature_extract", "model_predict"]
           params='{"input": "data.csv", "output": "result.csv"}'
```

## 注意事项

1. 工具调用应该保持原子性
2. 建议记录完整的请求和响应
3. 敏感信息应进行脱敏处理
4. 工具调用的结果应该包含足够的上下文信息


问题，工具的动态选择