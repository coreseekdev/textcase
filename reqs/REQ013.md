# REQ013: 测试用例关联与执行框架

## 1. 概述

本需求定义了一个完整的测试用例关联与执行框架，使用户能够在文档中关联和管理测试用例，并提供统一的执行机制。该框架允许用户直接从Markdown文件中记录、管理和执行测试用例，而无需关注项目实际使用的测试框架。

## 2. 目标

2.1. 建立标准化的Markdown文件测试用例记录格式

2.2. 提供命令行接口用于执行文档中引用的测试用例

2.3. 实现测试用例与实现代码之间的关联

2.4. 支持系统重构和演化过程中的测试用例管理

## 3. 命令行接口

3.1. 测试执行

```
tse run <测试标识符>
```

示例：
- `tse run REQ112/CASE-1` - 执行特定测试用例
- `tse run REQ112` - 执行模块中的所有测试用例
- `tse run /tests` - 执行项目中的所有测试用例

3.2. 测试发现

```
tse list <模块>/tests
```

## 4. 文档结构

4.1. 测试区域配置

测试区域可以在Markdown文档的前置元数据中定义：

```yaml
---
test_section: ["测试用例", "验证", "自动化测试"]
---
```

4.2. 测试用例格式

测试用例通过特定前缀的标题识别，并遵循结构化格式：

```markdown
## CASE-1: 测试用例标题

测试意图和目的描述。

- 前置条件1
- 前置条件2

```python
# 测试实现代码
print("hello world")
assert 结果 == 预期值
```

- 验证点1
- 验证点2

- 相关实现: [@code:文件.函数名](src/模块.py#函数)
```

4.3. 测试用例组件

4.3.1. 通过标题识别测试用例

4.3.2. 内联代码块作为测试脚本

4.3.3. URI引用外部测试脚本

4.3.4. 在父级区域描述设置和清理程序

4.3.5. 前置条件和验证点作为列表项

4.3.6. 使用语法 `[@类型:标识符](路径)` 的资源引用

## 5. 资源引用系统

5.1. 引用类型

5.1.1. 代码引用: `[@code:标识符](文件路径#锚点)`

5.1.2. 文档引用: `[@doc:标识符](文档路径#章节)`

5.1.3. URL引用: `[@url:标识符](https://example.com/docs#section)`

5.1.4. Shell脚本引用: `[@shell:标识符](脚本路径.sh)`

5.2. 引用解析

系统在需要时解析引用以显示或执行关联的资源。

## 6. 测试用例示例

```markdown
## CASE-1: 用户认证验证

验证用户可以使用有效凭据进行认证。

- 系统中存在用户"testuser"，密码为"password123"
- 认证服务正在运行

```python
from auth import login
result = login.authenticate_user("testuser", "password123")
assert result.success == True
assert result.token is not None
```

- 认证成功，状态码为200
- 返回有效的JWT令牌

- 相关实现: [@code:auth.login](src/auth/login.py#authenticate_user)
```

## 7. 实现考虑

7.1. 测试解析器

系统必须根据结构而非特定关键词解析Markdown文档以识别和提取测试用例，从而支持国际化。

7.2. 测试运行器

测试运行器必须支持多种执行环境（Python、Shell）并透明地处理不同的测试框架。

7.3. 引用系统

引用系统必须解析指向代码、文档和其他资源的链接，为测试用例提供上下文。

## 8. 示例格式

```markdown
## CASE-1: 示例描述测试代码

介绍测试意图

- 假设条件1
- 假设条件2

```python
print("hello world")
```

或

```shell
$ py-test test.py
```

- 检查点1（post check)
- 检查点2（post check)

- 相关资源: [@code:file.xxx_fn](src/module.py#function)
```

## 9. 资源引用方式

- 代码函数引用: `[@code:src/textcase/core/markdown_item.py#parse_markdown]`
- 文档章节引用: `[@doc:REQ006#文档格式]()`
- 网址引用: `[@url:https://example.com/docs#section-3]`
- 脚本引用: `[@shell:./scripts/test.sh]`