# REQ017: 项目(Project)与模块(Module)体系及其定位方案

## 概述

本规范定义了系统中项目(Project)与模块(Module)的概念体系，以及如何在系统中定位和引用特定模块中的文档资源。这是构建结构化文档管理系统的基础架构。

## 核心概念

1. **项目(Project)**：
   
   - 项目是系统中最高级别的组织单元，代表一个完整的工作空间
   - 项目可以看作一种特殊的根模块(root module)
   - 项目配置通常存储在项目根目录的`.textcase.yml`文件中
   - 示例：软件开发项目、文档写作项目、研究项目等

2. **模块(Module)**：
   
   - 模块是项目内的文档集合，具有相同的前缀和命名规则
   - 每个模块由唯一的前缀(prefix)标识，在整个项目空间中不可重复
   - 模块可以有父子关系，子模块存储在父模块的相对路径下
   - 每个模块可以在自身路径下有独立的`.textcase.yml`配置文件
   - 示例：需求模块(REQ)、测试模块(TST)、设计模块(DES)等

3. **源码模块(Source Module)**：
   
   - 源码模块是一种特殊类型的模块，用于管理和引用程序源代码
   - 源码模块与根模块平级，直接注册到项目中
   - 可以用于管理项目自身的源代码或引用第三方组件
   - 示例：项目源码模块(SRC)、外部依赖模块(EXTERNAL)
   - 定位格式：`{source_module}/{path/to/file.py}`，如`SRC/src/textcase/core/vfs.py`

4. **文档项(Document Item)**：
   
   - 文档项是模块中的基本单元，在代码中对应CaseItem
   - 每个文档项由模块前缀和唯一ID标识
   - ID可以是数字或字符串，只需在模块内保证唯一性
   - 示例：`REQ001`、`TST-auth`、`DES_UI`等

5. **模块配置**：
   
   ```yaml
   modules:
     REQ:  # 模块名称
       CHAT: chat  # 关联的其他模块
       TST: tests  # 关联的其他模块和路径
   settings:
     default_tag: []  # 默认标签
     digits: 3    # ID数字位数
     extension: .md  # 文件扩展名
     prefix: REQ  # 文档前缀
     sep: ''      # ID与数字间的分隔符
   tags:
   - TODO  # 可用的标签
   - DOING
   - DONE
   source:  # 源码模块配置
     SRC:  # 项目源码模块
       path: src  # 源码目录路径
       SUB_MODULE: module_path # SUB_MODULE 必须是 src 下的子目录
     EXTERNAL:  # 外部依赖模块
       path: lib  # 外部依赖目录路径
   ```
   
   - `modules` 定义了模块的父子关系，如 TST 的父模块是 REQ，路径为 tests
   - `settings` 定义了模块的基本配置
   - `tags` 定义了可用的文档标签
   - `source` 定义了源码模块，与根模块平级，直接注册到项目中

## 模块定位方案

1. **模块内文档定位**：
   
   - 基于前缀和ID定位特定文档
   - 格式：`{prefix}{sep}{id}{extension}`
   - 示例：`REQ001.md`、`TST002.md`
   - 注意：前导零是可选的，系统会自动处理，如`REQ1`与`REQ001`等价
   - ID可以是数字或字符串，只需保证唯一性

2. **路径解析**：
   
   - 通过前缀和 ID 定位文档
   - 格式：`{prefix}{id}`，分隔符可选
      - `{prefix}{sep}{id}`
      - `{prefix}{id}` sep 为可选
   - 示例：从REQ001引用测试用例 `TST001`
   - 示例：指定`REQ002`（由于前缀唯一，无需额外定位辅助， 同 模块内文档定位）
   - 系统会根据模块前缀直接定位到正确的文档
   - 如果只给出前缀，含义是定位到 模块（ module ）

3. **标签机制**：
   
   - 文档项可以标记一个或多个标签（如TODO、DOING、DONE）
   - 当文档项被标记时，系统会在其所在目录创建以标签名命名的文件（无扩展名）
   - 标签文件中记录了所有带有该标签的文档项的标识符（`{prefix}{sep}{id}`）
   - 示例：`TODO`文件中可能包含`REQ001`、`REQ002`等

4. **源码模块定位**：
   
   - 通过源码模块前缀和文件路径定位源代码文件
   - 格式：`{source_module}/{path/to/file.py}`
   - 示例：`SRC/src/textcase/core/vfs.py`定位到项目源码文件
   - 可以进一步定位到文件中的程序元素：`SRC/src/textcase/core/vfs.py/get_default_vfs`
   - 支持使用片段标识定位到特定行或范围：`SRC/src/textcase/core/vfs.py#L10-L20`

## 实现要点

当前代码中，下面的功能均已实现。

1. **模块注册机制**：
   
   - 系统启动时加载项目配置，注册所有模块
   - 每个模块维护自己的文档索引和关联关系
   - 模块前缀在整个项目中唯一，便于快速定位

2. **路径解析算法**：
   
   - 解析模块前缀和文档ID
   - 处理数字前导零和可选扩展名
   - 支持字符串类型的ID
   - 基于模块前缀的唯一性进行快速定位

3. **文档ID生成**：
   
   - 根据模块配置自动生成新文档ID
   - 确保ID在模块内唯一
   - 支持数字ID和字符串ID
   - 遵循配置中定义的数字位数和分隔符规则

4. **标签管理机制**：
   
   - 系统维护标签文件与文档项之间的关联
   - 当文档项标签变更时自动更新标签文件
   - 支持按标签查询文档项

5. **源码模块管理**：
   
   - 系统启动时从项目配置中加载源码模块配置
   - 源码模块与根模块平级，直接注册到项目中
   - 支持定位到源代码文件、程序元素和行范围
   - 可以处理多种源码类型（Python、JavaScript等）
   - 支持在文档中引用源码文件和程序元素
